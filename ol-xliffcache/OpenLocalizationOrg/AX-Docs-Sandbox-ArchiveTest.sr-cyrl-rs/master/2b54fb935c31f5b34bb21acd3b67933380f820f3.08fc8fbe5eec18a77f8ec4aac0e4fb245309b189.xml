{"content":"---\n# required metadata\n\ntitle: Loyalty extension sample\ndescription: This topic explains how to set up the system so that customers can both earn loyalty points and pay by using loyalty points in the same transaction.\nauthor: ShalabhjainMSFT\nmanager: AnnBe\nms.date: 05/15/2017\nms.topic: article\nms.prod: \nms.service: dynamics-365-retail\nms.technology: \n\n# optional metadata\n\n# ms.search.form: \n# ROBOTS: \naudience: Developer\n# ms.devlang: \nms.reviewer: robinr\nms.search.scope: AX 7.0.0, Operations, Retail, UnifiedOperations\n# ms.tgt_pltfrm: \nms.custom: 196163\nms.assetid:\nms.search.region: Global\nms.search.industry: Retail\nms.author: mumani\nms.search.validFrom: 2017-05-15\nms.dyn365.ops.version: AX 7.0.0, Retail July 2017 update\n\n---\n\n# Loyalty extension sample\n\n## Scenario \nA retailer wants customers to be able to earn loyalty points and pay by using loyalty points in a single transaction. \n\n## Scenario details\nThe retailer has set up a loyalty scheme for the channel and associated that scheme with a loyalty program. The loyalty scheme includes some earning and redemption rules. The retailer wants customers to be able to partially pay a transaction amount by using their loyalty points. The customers should then be able to earn loyalty points for the remaining transaction amount that they pay by using other payment methods.\n\n## Assumptions\nBecause of the flexibility that the loyalty setup provides, this scenario can quickly become very complex. We have made some assumptions to reduce the complexity of this sample. However, these assumptions aren't far removed from the real-world examples. Here are the assumptions:\n\n+ No tiers are associated with the loyalty program.\n+ There is a single loyalty scheme and a single loyalty reward point type.\n+ There is a single earning rule that applies to all product categories. For example, this rule might specify that, for every $1 that the customer spends, he or she earns 0.1 reward point. \n+ There is a single redemption rule that applies to all product categories. For example, this rule might specify that one reward point is equivalent to $1.\n\n> [!NOTE] \n> The earning and redemption rules that are mentioned here are just examples. For this sample, we have hard-coded the values. For a production scenario, the values should be read from the database instead.\n\n## Customization approach\nWe implement this customization in two steps. In step 1, points will be earned as though loyalty points weren't used in the transaction. Then, in step 2, the extra points that were earned will be reduced, based on the points that were redeemed.\n\nThere are six service requests for the loyalty feature:\n\n+ GetLoyaltyCardStatusServiceRequest\n+ CalculateLoyaltyRewardPointsServiceRequest\n+ IssueLoyaltyCardServiceRequest\n+ FillInLoyaltyRewardPointLinesForSalesServiceRequest\n+ FillInLoyaltyRewardPointLinesForReturnServiceRequest\n+ FillInLoyaltyRewardPointLinesForEarnOrDeductServiceRequest\n\nTo calculate the reward points for a cash-and-carry transaction, the system uses **FillInLoyaltyRewardPointLinesForSalesServiceRequest** for sales transaction lines. This request, in turn, uses **FillInLoyaltyRewardPointLinesForEarnOrDeductServiceRequest** to do the actual reward calculation. Similarly, the system uses **FillInLoyaltyRewardPointLinesForReturnServiceRequest** for return transaction lines, and this request also uses **FillInLoyaltyRewardPointLinesForEarnOrDeductServiceRequest** to do the actual reward calculation. In the out-of-box implementation of the loyalty feature, customers can't both redeem and earn loyalty points in the same transaction. In other words, if the sales transaction has a tender line for the loyalty card, **FillInLoyaltyRewardPointLinesForSalesServiceRequest** doesn't call **FillInLoyaltyRewardPointLinesForEarnOrDeductServiceRequest** to calculate the reward points. \n\nTo enable loyalty points to be redeemed and earned in the same transaction, we will work with one service request,  **FillInLoyaltyRewardPointLinesForSalesServiceRequest**.\n\n### Step 1 \n\nFor our scenario, we must implement **FillInLoyaltyRewardPointLinesForSalesServiceRequest** in such a way that it always calls **FillInLoyaltyRewardPointLinesForEarnOrDeductServiceRequest** to calculate the reward points. However, this change will cause the system to calculate extra earned points, based on the amount that the customer pays by using loyalty points. Therefore, we must be able to reduce the earned points by an appropriate amount. This adjustment is done in step 2.\n\n### Step 2\n\nWe take advantage of the post trigger mechanism that the extensibility framework provides on **FillInLoyaltyRewardPointLinesForSalesServiceRequest**. In the post trigger, we will use the earning and redemption rules to determine how many extra points were earned for each reward point that was redeemed. We will then subtract those extra points to get the correct amount.\n\n#### Implement FillInLoyaltyRewardPointLinesForSalesServiceRequest \n\n```cs\nnamespace Contoso\n{\n    namespace Commerce.Runtime.EarnRedeemLoyalty\n    {\n        using System;\n        using Microsoft.Dynamics.Commerce.Runtime;\n        using Microsoft.Dynamics.Commerce.Runtime.DataModel;\n        using Microsoft.Dynamics.Commerce.Runtime.DataServices.Messages;\n        using Microsoft.Dynamics.Commerce.Runtime.Services.Messages;\n        using System.Collections.Generic;\n        using Microsoft.Dynamics.Commerce.Runtime.Messages;\n        \n        public class FillInLoyaltyRewardPointLinesForSalesHandler : IRequestHandler\n        {\n            /// <summary>\n            /// Gets the collection of supported request types by this handler.\n            /// </summary>\n            public IEnumerable<Type> SupportedRequestTypes\n            {\n                get\n                {\n                    return new[]\n                    {\n                        typeof(FillInLoyaltyRewardPointLinesForSalesServiceRequest),\n                    };\n                }\n            }\n            /// <summary>\n            /// Entry point to FillInLoyaltyRewardPointLinesForSalesServiceRequest service.\n            /// </summary>\n            /// <param name=\"request\">The request to execute.</param>\n            /// <returns>Returns the SalesTransaction object with the one or more LoyaltyRewardPointLines.</returns>\n            public Response Execute(Request request)\n            {\n                ThrowIf.Null(request, \"request\");\n                var LoyaltyRewardPointLinesForSalesServiceRequest = (FillInLoyaltyRewardPointLinesForSalesServiceRequest)request;\n                SalesTransaction salesTransaction = LoyaltyRewardPointLinesForSalesServiceRequest.SalesTransaction;\n                // Call the service to calculate the loyalty reward points.                \n                var fillInLoyaltyRewardPointLinesForEarnOrDeductServiceRequest = new FillInLoyaltyRewardPointLinesForEarnOrDeductServiceRequest(salesTransaction, LoyaltyRewardPointLinesForSalesServiceRequest.EarnSchemeLines, LoyaltyRewardPointEntryType.Earn);\n                var fillInLoyaltyRewardPointLinesForEarnOrDeductServiceResponse = request.RequestContext.Execute<SingleEntityDataServiceResponse<SalesTransaction>>(fillInLoyaltyRewardPointLinesForEarnOrDeductServiceRequest);\n                salesTransaction = fillInLoyaltyRewardPointLinesForEarnOrDeductServiceResponse.Entity;\n                return new SingleEntityDataServiceResponse<SalesTransaction>(salesTransaction);\n            }\n        }\n    }\n}\n```\n\n#### Implement the post trigger for FillInLoyaltyRewardPointLinesForSalesServiceRequest\n\n```cs\nnamespace Contoso\n{\n    namespace Commerce.Runtime.Sample.EarnRedeemLoyalty\n    {\n        using System;\n        using System.Collections.Generic;\n        using System.Linq;\n        using Microsoft.Dynamics.Commerce.Runtime;\n        using Microsoft.Dynamics.Commerce.Runtime.Messages;\n        using Microsoft.Dynamics.Commerce.Runtime.Services.Messages;\n        using Microsoft.Dynamics.Commerce.Runtime.DataModel;\n        class AdjustLoyatyRewardsTrigger : IRequestTrigger\n        {\n            public IEnumerable<Type> SupportedRequestTypes\n            {\n                get { return new[] { typeof(FillInLoyaltyRewardPointLinesForSalesServiceRequest) }; }\n            }\n            public void OnExecuted(Request request, Response response)\n            {\n                ThrowIf.Null(request, \"request\");\n                var LoyaltyRewardPointSalesServiceRequest = (FillInLoyaltyRewardPointLinesForSalesServiceRequest)request;\n                SalesTransaction salesTransaction = LoyaltyRewardPointSalesServiceRequest.SalesTransaction;\n                                \n                if (salesTransaction.LoyaltyRewardPointLines != null)\n                {\n                    decimal totalReedeemedPoints = 0m;\n                    decimal extraEarnedPoints = 0m;\n                    \n                    // Find the redeemed reward lines in the transaction and calculate the total redeemed reward points\n                    IEnumerable<LoyaltyRewardPointLine> redeemLoyaltyRewardPointLines = salesTransaction.LoyaltyRewardPointLines.Where<LoyaltyRewardPointLine>(line => line.EntryType == LoyaltyRewardPointEntryType.Redeem);\n                    if (redeemLoyaltyRewardPointLines.Count() > 0)\n                    {                        \n                        foreach (var rewardPointLine in redeemLoyaltyRewardPointLines)\n                        {\n                            totalReedeemedPoints += rewardPointLine.RewardPointAmountQuantity;\n                        }\n                        // Calculate the number of extra earned points for every redeemed point.\n                        // If the earning rules stated that for every $1 spent, the user earns X points and redemption rule was that Y points equal $1 then, for every redemption point the user earns X/Y extra earn points.\n                        // Based on the above logic, in this sample, for every redeemed point the user earns .1/1 = .1 extra earned points.\n                        extraEarnedPoints = .1m * totalReedeemedPoints; \n                    }\n                    // Reduce the amount of earned points by the extraEarnedPoints calculated above.\n                    IEnumerable<LoyaltyRewardPointLine> earnLoyaltyRewardPointLines = salesTransaction.LoyaltyRewardPointLines.Where<LoyaltyRewardPointLine>(line => line.EntryType == LoyaltyRewardPointEntryType.Earn);\n                    if (earnLoyaltyRewardPointLines.Count() > 0)\n                    {\n                        earnLoyaltyRewardPointLines.FirstOrDefault().RewardPointAmountQuantity -= extraEarnedPoints;\n                    }\n                }\n            }\n            public void OnExecuting(Request request)\n            { }\n        }\n    }\n}\n```\n","nodes":[{"pos":[4,733],"embed":true,"restype":"x-metadata","content":"# required metadata\n\ntitle: Loyalty extension sample\ndescription: This topic explains how to set up the system so that customers can both earn loyalty points and pay by using loyalty points in the same transaction.\nauthor: ShalabhjainMSFT\nmanager: AnnBe\nms.date: 05/15/2017\nms.topic: article\nms.prod: \nms.service: dynamics-365-retail\nms.technology: \n\n# optional metadata\n\n# ms.search.form: \n# ROBOTS: \naudience: Developer\n# ms.devlang: \nms.reviewer: robinr\nms.search.scope: AX 7.0.0, Operations, Retail, UnifiedOperations\n# ms.tgt_pltfrm: \nms.custom: 196163\nms.assetid:\nms.search.region: Global\nms.search.industry: Retail\nms.author: mumani\nms.search.validFrom: 2017-05-15\nms.dyn365.ops.version: AX 7.0.0, Retail July 2017 update\n","nodes":[{"content":"Loyalty extension sample","nodes":[{"pos":[0,24],"content":"Loyalty extension sample","nodes":[{"content":"Loyalty extension sample","pos":[0,24]}]}],"path":["title"],"extradata":"MT"},{"content":"This topic explains how to set up the system so that customers can both earn loyalty points and pay by using loyalty points in the same transaction.","nodes":[{"pos":[0,148],"content":"This topic explains how to set up the system so that customers can both earn loyalty points and pay by using loyalty points in the same transaction.","nodes":[{"content":"This topic explains how to set up the system so that customers can both earn loyalty points and pay by using loyalty points in the same transaction.","pos":[0,148]}]}],"path":["description"],"extradata":"MT"}],"header":"# required metadata\n","yml":true},{"pos":[741,765],"content":"Loyalty extension sample","linkify":"Loyalty extension sample","nodes":[{"content":"Loyalty extension sample","pos":[0,24]}]},{"pos":[770,778],"content":"Scenario","linkify":"Scenario","nodes":[{"content":"Scenario","pos":[0,8]}]},{"content":"A retailer wants customers to be able to earn loyalty points and pay by using loyalty points in a single transaction.","pos":[780,897]},{"pos":[903,919],"content":"Scenario details","linkify":"Scenario details","nodes":[{"content":"Scenario details","pos":[0,16]}]},{"content":"The retailer has set up a loyalty scheme for the channel and associated that scheme with a loyalty program.","pos":[920,1027]},{"content":"The loyalty scheme includes some earning and redemption rules.","pos":[1028,1090]},{"content":"The retailer wants customers to be able to partially pay a transaction amount by using their loyalty points.","pos":[1091,1199]},{"content":"The customers should then be able to earn loyalty points for the remaining transaction amount that they pay by using other payment methods.","pos":[1200,1339]},{"pos":[1344,1355],"content":"Assumptions","linkify":"Assumptions","nodes":[{"content":"Assumptions","pos":[0,11]}]},{"content":"Because of the flexibility that the loyalty setup provides, this scenario can quickly become very complex.","pos":[1356,1462]},{"content":"We have made some assumptions to reduce the complexity of this sample.","pos":[1463,1533]},{"content":"However, these assumptions aren't far removed from the real-world examples.","pos":[1534,1609]},{"content":"Here are the assumptions:","pos":[1610,1635]},{"content":"No tiers are associated with the loyalty program.","pos":[1639,1688]},{"content":"There is a single loyalty scheme and a single loyalty reward point type.","pos":[1691,1763]},{"content":"There is a single earning rule that applies to all product categories.","pos":[1766,1836]},{"content":"For example, this rule might specify that, for every $1 that the customer spends, he or she earns 0.1 reward point.","pos":[1837,1952]},{"content":"There is a single redemption rule that applies to all product categories.","pos":[1956,2029]},{"content":"For example, this rule might specify that one reward point is equivalent to $1.","pos":[2030,2109]},{"pos":[2113,2327],"content":"[!NOTE] \nThe earning and redemption rules that are mentioned here are just examples. For this sample, we have hard-coded the values. For a production scenario, the values should be read from the database instead.","leadings":["","> "],"nodes":[{"content":"The earning and redemption rules that are mentioned here are just examples. For this sample, we have hard-coded the values. For a production scenario, the values should be read from the database instead.","pos":[9,212],"nodes":[{"content":"The earning and redemption rules that are mentioned here are just examples.","pos":[0,75]},{"content":"For this sample, we have hard-coded the values.","pos":[76,123]},{"content":"For a production scenario, the values should be read from the database instead.","pos":[124,203]}]}]},{"pos":[2332,2354],"content":"Customization approach","linkify":"Customization approach","nodes":[{"content":"Customization approach","pos":[0,22]}]},{"content":"We implement this customization in two steps.","pos":[2355,2400]},{"content":"In step 1, points will be earned as though loyalty points weren't used in the transaction.","pos":[2401,2491]},{"content":"Then, in step 2, the extra points that were earned will be reduced, based on the points that were redeemed.","pos":[2492,2599]},{"content":"There are six service requests for the loyalty feature:","pos":[2601,2656]},{"content":"GetLoyaltyCardStatusServiceRequest","pos":[2660,2694]},{"content":"CalculateLoyaltyRewardPointsServiceRequest","pos":[2697,2739]},{"content":"IssueLoyaltyCardServiceRequest","pos":[2742,2772]},{"content":"FillInLoyaltyRewardPointLinesForSalesServiceRequest","pos":[2775,2826]},{"content":"FillInLoyaltyRewardPointLinesForReturnServiceRequest","pos":[2829,2881]},{"content":"FillInLoyaltyRewardPointLinesForEarnOrDeductServiceRequest","pos":[2884,2942]},{"content":"To calculate the reward points for a cash-and-carry transaction, the system uses <bpt id=\"p1\">**</bpt>FillInLoyaltyRewardPointLinesForSalesServiceRequest<ept id=\"p1\">**</ept> for sales transaction lines.","pos":[2944,3109],"source":"To calculate the reward points for a cash-and-carry transaction, the system uses **FillInLoyaltyRewardPointLinesForSalesServiceRequest** for sales transaction lines."},{"content":"This request, in turn, uses <bpt id=\"p1\">**</bpt>FillInLoyaltyRewardPointLinesForEarnOrDeductServiceRequest<ept id=\"p1\">**</ept> to do the actual reward calculation.","pos":[3110,3237],"source":" This request, in turn, uses **FillInLoyaltyRewardPointLinesForEarnOrDeductServiceRequest** to do the actual reward calculation."},{"content":"Similarly, the system uses <bpt id=\"p1\">**</bpt>FillInLoyaltyRewardPointLinesForReturnServiceRequest<ept id=\"p1\">**</ept> for return transaction lines, and this request also uses <bpt id=\"p2\">**</bpt>FillInLoyaltyRewardPointLinesForEarnOrDeductServiceRequest<ept id=\"p2\">**</ept> to do the actual reward calculation.","pos":[3238,3478],"source":" Similarly, the system uses **FillInLoyaltyRewardPointLinesForReturnServiceRequest** for return transaction lines, and this request also uses **FillInLoyaltyRewardPointLinesForEarnOrDeductServiceRequest** to do the actual reward calculation."},{"content":"In the out-of-box implementation of the loyalty feature, customers can't both redeem and earn loyalty points in the same transaction.","pos":[3479,3612]},{"content":"In other words, if the sales transaction has a tender line for the loyalty card, <bpt id=\"p1\">**</bpt>FillInLoyaltyRewardPointLinesForSalesServiceRequest<ept id=\"p1\">**</ept> doesn't call <bpt id=\"p2\">**</bpt>FillInLoyaltyRewardPointLinesForEarnOrDeductServiceRequest<ept id=\"p2\">**</ept> to calculate the reward points.","pos":[3613,3857],"source":" In other words, if the sales transaction has a tender line for the loyalty card, **FillInLoyaltyRewardPointLinesForSalesServiceRequest** doesn't call **FillInLoyaltyRewardPointLinesForEarnOrDeductServiceRequest** to calculate the reward points."},{"pos":[3860,4032],"content":"To enable loyalty points to be redeemed and earned in the same transaction, we will work with one service request,  <bpt id=\"p1\">**</bpt>FillInLoyaltyRewardPointLinesForSalesServiceRequest<ept id=\"p1\">**</ept>.","source":"To enable loyalty points to be redeemed and earned in the same transaction, we will work with one service request,  **FillInLoyaltyRewardPointLinesForSalesServiceRequest**."},{"pos":[4038,4044],"content":"Step 1","linkify":"Step 1","nodes":[{"content":"Step 1","pos":[0,6]}]},{"content":"For our scenario, we must implement <bpt id=\"p1\">**</bpt>FillInLoyaltyRewardPointLinesForSalesServiceRequest<ept id=\"p1\">**</ept> in such a way that it always calls <bpt id=\"p2\">**</bpt>FillInLoyaltyRewardPointLinesForEarnOrDeductServiceRequest<ept id=\"p2\">**</ept> to calculate the reward points.","pos":[4047,4268],"source":"For our scenario, we must implement **FillInLoyaltyRewardPointLinesForSalesServiceRequest** in such a way that it always calls **FillInLoyaltyRewardPointLinesForEarnOrDeductServiceRequest** to calculate the reward points."},{"content":"However, this change will cause the system to calculate extra earned points, based on the amount that the customer pays by using loyalty points.","pos":[4269,4413]},{"content":"Therefore, we must be able to reduce the earned points by an appropriate amount.","pos":[4414,4494]},{"content":"This adjustment is done in step 2.","pos":[4495,4529]},{"pos":[4535,4541],"content":"Step 2","linkify":"Step 2","nodes":[{"content":"Step 2","pos":[0,6]}]},{"content":"We take advantage of the post trigger mechanism that the extensibility framework provides on <bpt id=\"p1\">**</bpt>FillInLoyaltyRewardPointLinesForSalesServiceRequest<ept id=\"p1\">**</ept>.","pos":[4543,4692],"source":"We take advantage of the post trigger mechanism that the extensibility framework provides on **FillInLoyaltyRewardPointLinesForSalesServiceRequest**."},{"content":"In the post trigger, we will use the earning and redemption rules to determine how many extra points were earned for each reward point that was redeemed.","pos":[4693,4846]},{"content":"We will then subtract those extra points to get the correct amount.","pos":[4847,4914]},{"pos":[4921,4982],"content":"Implement FillInLoyaltyRewardPointLinesForSalesServiceRequest","linkify":"Implement FillInLoyaltyRewardPointLinesForSalesServiceRequest","nodes":[{"content":"Implement FillInLoyaltyRewardPointLinesForSalesServiceRequest","pos":[0,61]}]},{"pos":[7499,7581],"content":"Implement the post trigger for FillInLoyaltyRewardPointLinesForSalesServiceRequest","linkify":"Implement the post trigger for FillInLoyaltyRewardPointLinesForSalesServiceRequest","nodes":[{"content":"Implement the post trigger for FillInLoyaltyRewardPointLinesForSalesServiceRequest","pos":[0,82]}]}]}