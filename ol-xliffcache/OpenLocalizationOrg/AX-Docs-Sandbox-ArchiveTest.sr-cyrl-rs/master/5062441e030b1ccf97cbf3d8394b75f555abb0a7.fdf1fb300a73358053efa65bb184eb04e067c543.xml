{"content":"---\n# required metadata\n\ntitle: Block a transaction using triggers\ndescription: This topic shows how you can use a trigger to block an invoice or credit transaction.\nauthor: robinarh\nmanager: AnnBe\nms.date: 06/20/2017\nms.topic: article\nms.prod: \nms.service: dynamics-365-retail\nms.technology: \n\n# optional metadata\n\n# ms.search.form: \n# ROBOTS: \naudience: Developer\n# ms.devlang: \nms.reviewer: robinr\nms.search.scope: AX 7.0.0, Operations, Retail, UnifiedOperations\n# ms.tgt_pltfrm: \nms.custom: 65893\nms.assetid: 605f5986-f84f-4b18-b94e-b0912cb367a1\nms.search.region: Global\n# ms.search.industry: \nms.author: mumani\nms.search.validFrom: 2016-02-28\nms.dyn365.ops.version: AX 7.0.0, Retail July 2017 update\n\n---\n\n# Block a transaction using triggers\n\n[!include[banner](../includes/banner.md)]\n\n\nThis topic shows how you can use a trigger to block an invoice or credit transaction.\n\nThis topic shows how you can block an invoice or credit transaction.\n\n1.  Open Visual Studio as an administrator. Create a new Visual C\\# Class Library (Portable) project and name it CRTTriggerExtension. If you get a message that the selection makes this project incompatible with Visual Studio 2010, click **OK**.\n2.  In Solution Explorer, rename default class1.cs to GetCustomersServiceRequestTrigger.cs.\n3.  Right-click the **Reference** node in the project and add the following references. The location of the references will depend on the deployment topology.\n    -   Microsoft.Dynamics.Commerce.Runtime.Entities.dll\n    -   Microsoft.Dynamics.Commerce.Runtime.Framework.dll\n    -   Microsoft.Dynamics.Commerce.Runtime.Services.Messages.dll\n\n4.  Add the following **using** statement to the GetCustomersServiceRequestTrigger.cs file.\n\n        using Microsoft.Dynamics.Commerce.Runtime.Messages;\n        using Microsoft.Dynamics.Commerce.Runtime.Services.Messages;\n        using Microsoft.Dynamics.Commerce.Runtime;\n\n5.  Rename class1.cs in the code to GetCustomersServiceRequestTrigger and then add the IRequestTrigger interface declaration.\n\n        using System;\n        using System.Collections.Generic;\n        using System.Linq;\n        using Microsoft.Dynamics.Commerce.Runtime;\n        using Microsoft.Dynamics.Commerce.Runtime.Services.Messages;\n        using Microsoft.Dynamics.Commerce.Runtime.Messages;\n\n        namespace CRTTriggerExtension\n        public class GetCustomersServiceRequestTrigger : IRequestTrigger\n        {\n\n6.  Implement the IRequestTrigger interface trigger. Right-click the IRequestTrigger class, select **Quick Actions**, and then click **Implement Interface**. Visual Studio will implement the interface. You can also place the cursor on IRequestTrigger, press **Ctrl+**, and select **Implement Interface**.\n7.  The empty interface members SupportedRequestTypes, OnExecuted, and OnExecuting methods are shown in the following code example.\n\n        public class GetCustomersServiceRequestTrigger : IRequestTrigger\n        {\n            public IEnumerable<Type> SupportedRequestTypes\n            {\n                get\n                {\n                    throw new NotImplementedException();\n                }\n            }\n\n            public void OnExecuted(Request request, Response response)\n            {\n                throw new NotImplementedException();\n            }\n\n            public void OnExecuting(Request request)\n            {\n                throw new NotImplementedException();\n            } \n        }\n\n8.  Retail Server uses the GetCustomersServiceRequest object to get the customer details from Commerce Runtime (CRT) and uses the GetCustomersServiceRequest object to add the customer to the transaction. Before adding the customer to the transaction you need to check whether the customer is blocked. To do this, implement a post trigger for this request and check whether the customer is blocked. If the customer is blocked, then throw the exception to MPOS.\n9.  In the SupportedRequestTypes method tell the CRT that you are going to add the trigger for GetCustomersServiceRequest. The following code example shows how to add GetCustomersServiceRequest as a supported type.\n\n        public IEnumerable<Type> SupportedRequestTypes\n        {\n            get\n            {\n                return new[] { typeof(GetCustomersServiceRequest) };       \n            }\n        }\n\n10. Check if the customer is blocked in the OnExecuted (post trigger) method with the following code.\n\n        public void OnExecuted(Request request, Response response)\n        {\n            if (response == null)\n            {\n            throw new ArgumentNullException(\"request\");\n            }\n\n            var getCustomersServiceResponse = (GetCustomersServiceResponse)response;\n            if(getCustomersServiceResponse.Customers.FirstOrDefault().Blocked == true)\n            {\n                string message = string.Format(\"Failed to add customer '{0}' to cart. Blocked customers are not allowed for transactions.\",\n                    getCustomersServiceResponse.Customers.FirstOrDefault().AccountNumber);\n                throw new CartValidationException(DataValidationErrors.Microsoft_Dynamics_Commerce_Runtime_CustomerAccountIsBlocked, message);\n            }\n        }\n\n11. Finally, update the OnExecuting method with the following code.\n\n        public void OnExecuting(Request request) \n        {\n            if (request == null)\n            {\n                throw new ArgumentNullException(\"request\");\n            }\n        }\n\n12. Click **Save**.\n\n\n\n\n","nodes":[{"pos":[4,705],"embed":true,"restype":"x-metadata","content":"# required metadata\n\ntitle: Block a transaction using triggers\ndescription: This topic shows how you can use a trigger to block an invoice or credit transaction.\nauthor: robinarh\nmanager: AnnBe\nms.date: 06/20/2017\nms.topic: article\nms.prod: \nms.service: dynamics-365-retail\nms.technology: \n\n# optional metadata\n\n# ms.search.form: \n# ROBOTS: \naudience: Developer\n# ms.devlang: \nms.reviewer: robinr\nms.search.scope: AX 7.0.0, Operations, Retail, UnifiedOperations\n# ms.tgt_pltfrm: \nms.custom: 65893\nms.assetid: 605f5986-f84f-4b18-b94e-b0912cb367a1\nms.search.region: Global\n# ms.search.industry: \nms.author: mumani\nms.search.validFrom: 2016-02-28\nms.dyn365.ops.version: AX 7.0.0, Retail July 2017 update\n","nodes":[{"content":"Block a transaction using triggers","nodes":[{"pos":[0,34],"content":"Block a transaction using triggers","nodes":[{"content":"Block a transaction using triggers","pos":[0,34]}]}],"path":["title"],"extradata":"MT"},{"content":"This topic shows how you can use a trigger to block an invoice or credit transaction.","nodes":[{"pos":[0,85],"content":"This topic shows how you can use a trigger to block an invoice or credit transaction.","nodes":[{"content":"This topic shows how you can use a trigger to block an invoice or credit transaction.","pos":[0,85]}]}],"path":["description"],"extradata":"MT"}],"header":"# required metadata\n","yml":true},{"pos":[713,747],"content":"Block a transaction using triggers","linkify":"Block a transaction using triggers","nodes":[{"content":"Block a transaction using triggers","pos":[0,34]}]},{"content":"This topic shows how you can use a trigger to block an invoice or credit transaction.","pos":[793,878]},{"content":"This topic shows how you can block an invoice or credit transaction.","pos":[880,948]},{"content":"Open Visual Studio as an administrator.","pos":[954,993]},{"content":"Create a new Visual C<ph id=\"ph1\">\\#</ph> Class Library (Portable) project and name it CRTTriggerExtension.","pos":[994,1083],"source":" Create a new Visual C\\# Class Library (Portable) project and name it CRTTriggerExtension."},{"content":"If you get a message that the selection makes this project incompatible with Visual Studio 2010, click <bpt id=\"p1\">**</bpt>OK<ept id=\"p1\">**</ept>.","pos":[1084,1194],"source":" If you get a message that the selection makes this project incompatible with Visual Studio 2010, click **OK**."},{"content":"In Solution Explorer, rename default class1.cs to GetCustomersServiceRequestTrigger.cs.","pos":[1199,1286]},{"content":"Right-click the <bpt id=\"p1\">**</bpt>Reference<ept id=\"p1\">**</ept> node in the project and add the following references.","pos":[1291,1374],"source":"Right-click the **Reference** node in the project and add the following references."},{"content":"The location of the references will depend on the deployment topology.","pos":[1375,1445]},{"content":"Microsoft.Dynamics.Commerce.Runtime.Entities.dll","pos":[1454,1502]},{"content":"Microsoft.Dynamics.Commerce.Runtime.Framework.dll","pos":[1511,1560]},{"content":"Microsoft.Dynamics.Commerce.Runtime.Services.Messages.dll","pos":[1569,1626]},{"pos":[1632,1719],"content":"Add the following <bpt id=\"p1\">**</bpt>using<ept id=\"p1\">**</ept> statement to the GetCustomersServiceRequestTrigger.cs file.","source":"Add the following **using** statement to the GetCustomersServiceRequestTrigger.cs file."},{"content":"Rename class1.cs in the code to GetCustomersServiceRequestTrigger and then add the IRequestTrigger interface declaration.","pos":[1906,2027]},{"content":"Implement the IRequestTrigger interface trigger.","pos":[2427,2475]},{"content":"Right-click the IRequestTrigger class, select <bpt id=\"p1\">**</bpt>Quick Actions<ept id=\"p1\">**</ept>, and then click <bpt id=\"p2\">**</bpt>Implement Interface<ept id=\"p2\">**</ept>.","pos":[2476,2580],"source":" Right-click the IRequestTrigger class, select **Quick Actions**, and then click **Implement Interface**."},{"content":"Visual Studio will implement the interface.","pos":[2581,2624]},{"content":"You can also place the cursor on IRequestTrigger, press <bpt id=\"p1\">**</bpt>Ctrl+<ept id=\"p1\">**</ept>, and select <bpt id=\"p2\">**</bpt>Implement Interface<ept id=\"p2\">**</ept>.","pos":[2625,2727],"source":" You can also place the cursor on IRequestTrigger, press **Ctrl+**, and select **Implement Interface**."},{"content":"The empty interface members SupportedRequestTypes, OnExecuted, and OnExecuting methods are shown in the following code example.","pos":[2732,2859]},{"content":"Retail Server uses the GetCustomersServiceRequest object to get the customer details from Commerce Runtime (CRT) and uses the GetCustomersServiceRequest object to add the customer to the transaction.","pos":[3448,3647]},{"content":"Before adding the customer to the transaction you need to check whether the customer is blocked.","pos":[3648,3744]},{"content":"To do this, implement a post trigger for this request and check whether the customer is blocked.","pos":[3745,3841]},{"content":"If the customer is blocked, then throw the exception to MPOS.","pos":[3842,3903]},{"content":"In the SupportedRequestTypes method tell the CRT that you are going to add the trigger for GetCustomersServiceRequest.","pos":[3908,4026]},{"content":"The following code example shows how to add GetCustomersServiceRequest as a supported type.","pos":[4027,4118]},{"content":"Check if the customer is blocked in the OnExecuted (post trigger) method with the following code.","pos":[4320,4417]},{"content":"Finally, update the OnExecuting method with the following code.","pos":[5204,5267]},{"pos":[5465,5480],"content":"Click <bpt id=\"p1\">**</bpt>Save<ept id=\"p1\">**</ept>.","source":"Click **Save**."}]}